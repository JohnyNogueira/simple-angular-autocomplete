<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script type="text/javascript" src="angular.js"></script>

	<link rel="stylesheet" type="text/css" href="bootstrap.min.css">

	<style type="text/css">
		.autocomplete-options-container {
			position: relative;
		}

		.autocomplete-options-dropdown {
			position: absolute;
			top: -1px;
			left: 0px;
			border: 1px solid #ccc;
			border-top-color: #d9d9d9;
			box-shadow: 0 2px 4px rgba(0,0,0,0.2);
			-webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.2);
			cursor: default;
			z-index: 1001;
			background: white;
		}

		.autocomplete-options-list {
			list-style-type: none;
			margin: 0;
			padding: 0;
		}

		.autocomplete-option {
			padding: 2px 10px;
			line-height: 22px;
			overflow: hidden;
			font: normal normal normal 13.3333330154419px/normal Arial;
		}

		.autocomplete-option.selected {
			background-color: #eee;
		}

		.big {
			width: 500px;
		}
		
	</style>

	<script type="text/javascript">
		if (!Array.prototype.last){
		    Array.prototype.last = function(){
		        return this[this.length - 1];
		    };
		};

		if (!Array.prototype.first){
		    Array.prototype.first = function(){
		        return this[0];
		    };
		};

		if (!Array.prototype.contains){
		    Array.prototype.contains = function(it){
		        return this.indexOf(it) != -1;
		    };
		};

		if (!String.prototype.contains){
		    String.prototype.contains = function(it) {
		    	return this.indexOf(it) != -1;
		    };
		};

		var myApp = angular.module('myApp',[]);

		myApp.controller('TestCtrl', function($scope) {
			$scope.datas = [
				{title: 'The dog', age: 2},
				{title: 'The cat', age: 4},
				{title: 'The bird', age: 7}
			];
			
			$scope.onDo = function(name) {
				console.log(name);
			};
		})

		myApp.directive('myDirective', function(Keys) {
			return {
				templateUrl: 'autocomplete.html',
				scope: {
					options: '=',
					onSelect: '=',
					displayProperty: '=',
					inputClass: '@'
				},
				controller: function($scope){
					$scope.searchTerm = '';
					$scope.highlightedOption = null;
					$scope.showOptions = false;
					$scope.matchingOptions = [];
					$scope.hasMatches = false;
					$scope.selectedOption = null;

					$scope.isOptionSelected = function(option) {
						return option === $scope.highlightedOption;
					};

					$scope.processSearchTerm = function(term) {
						console.log('ch-ch-ch-changin');
						if (term.length > 0) {
							if ($scope.selectedOption) {
								if (term != $scope.selectedOption[$scope.displayProperty]) {
									$scope.selectedOption = null;
								} else {
									$scope.showOptions = false;
									$scope.clearHighlight();
									return;
								}
							}

							var matchingOptions = $scope.findMatchingOptions(term);
							$scope.matchingOptions = matchingOptions;
							if (!$scope.matchingOptions.contains($scope.highlightedOption)) {
								$scope.clearHighlight();
							}
							$scope.hasMatches = matchingOptions.length > 0;
							$scope.showOptions = true;
						} else {
							$scope.showOptions = false;
							$scope.clearHighlight();
						}
					};

					$scope.findMatchingOptions = function(term) {
						return $scope.options.filter(function(option) {
							var lowerCaseOption = option[$scope.displayProperty].toLowerCase();
							var lowerCaseTerm = term.toLowerCase();
							return lowerCaseOption.contains(lowerCaseTerm);
						});
					};

					$scope.keyDown = function(e) {
						switch(e.which) {
							case Keys.upArrow:
								e.preventDefault();
								if ($scope.showOptions) {
									$scope.highlightPrevious();
								}
								break;
							case Keys.downArrow:
								e.preventDefault();
								if ($scope.showOptions) {
									$scope.highlightNext();
								} else {
									$scope.showOptions = true;
								}
								break;
							case Keys.enter:
								e.preventDefault();
								$scope.selectOption($scope.highlightedOption);
								break;
						}
					};
					
					$scope.$watch('searchTerm', function(term){
						$scope.processSearchTerm(term);
						// $scope.onSelect(term);
					});

					$scope.highlightNext = function() {
						if (!$scope.highlightedOption) {
							$scope.highlightedOption = $scope.matchingOptions.first();
						} else {
							var currentIndex = $scope.currentOptionIndex();
							var nextIndex = currentIndex + 1 == $scope.matchingOptions.length ? 0 : currentIndex + 1;
							$scope.highlightedOption = $scope.matchingOptions[nextIndex];
						}
					};

					$scope.highlightPrevious = function() {
						if (!$scope.highlightedOption) {
							$scope.highlightedOption = $scope.matchingOptions.last();
						} else {
							var currentIndex = $scope.currentOptionIndex();
							var previousIndex = currentIndex == 0 ? $scope.matchingOptions.length - 1 : currentIndex - 1;
							$scope.highlightedOption = $scope.matchingOptions[previousIndex];
						}
					};

					$scope.clearHighlight = function() {
						$scope.highlightedOption = null;
					};

					$scope.selectOption = function(option) {
						$scope.selectedOption = option;
						$scope.searchTerm = option[$scope.displayProperty];
						$scope.onSelect(option);
					};

					$scope.onBlur = function() {
						$scope.showOptions = false;
						$scope.clearHighlight();
					};

					$scope.currentOptionIndex = function() {
						return $scope.matchingOptions.indexOf($scope.highlightedOption);
					};
				},
				link: function(scope, elem, attrs) {

				}
			};
		})

		myApp.factory('Keys', function() {
			return {
				upArrow: 38,
				downArrow: 40,
				enter: 13
			};
		});
	</script>
</head>
<body ng-app="myApp" ng-controller="TestCtrl" style="padding: 15px;">
	<div>
		<div my-directive 
		options="datas" 
		on-select="onDo" 
		display-property="'title'"
		input-class="form-control"></div>

		<p>More content</p>
	</div>

	<script type="text/ng-template" id="autocomplete.html">
		<input type="text"
			ng-class="inputClass"
			ng-model="searchTerm"
			ng-keydown="keyDown($event)"
			ng-blur="onBlur()" />

		<div class="autocomplete-options-container">
			<div class="autocomplete-options-dropdown" ng-if="showOptions">
				<div class="autocomplete-option" ng-if="!hasMatches">
					<span>No matches</span>
				</div>

				<ul class="autocomplete-options-list">
					<li class="autocomplete-option" 
						ng-class="{selected: isOptionSelected(option)}" 
						ng-repeat="option in matchingOptions"
						ng-if="!noMatches">
						<span>{{option[displayProperty]}}</span>
					</li>
				</ul>
			</div>
		</div>
	</script>
</body>
</html>